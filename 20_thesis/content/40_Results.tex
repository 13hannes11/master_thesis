\chapter{Results}
\label{ch:Results}


\section{Focus Distance Measures}
\label{sec:Results:FocusDistance}

\todo[inline, caption={}]{
    \begin{itemize}
        \item Shows the findings of the project, often in the form of data.
        \item Comments on those findings which illustrate the significance of the results.
        \item Data Commentary:
        \begin{itemize}
            \item It is important to comment on the visual information, highlighting to your reader what they should notice and why this is important. 
            \item Location statement
            \item Linking as-statement
            \item Highlighting statement: drawing attention to key information.
        \end{itemize} 
    \end{itemize}
}


\begin{table}
    \centering
    \caption{Comparing \acs{poop} models on the task of predicting the relative position of the focus plane.}
    \begin{tabular}{|l|rrrr|}
        \hline
        method          & \acs{mae} & \acs{srcc} & \acs{plcc} & \acs{r2} \\
        \hline
        \acs{poop}-\acs{fc}        & 0.0186 & -0.0384 & -0.0242 & -0.2058 \\
        \acs{poop}-\acs{cnn}        & 0.0166 &  0.2436 &  0.2339 &  0.0285 \\
        \acs{poop}-\acs{resnet}-101      & 0.0064 &  0.9177 &  0.9057 &  0.8121 \\
        \acs{poop}-\acs{resnet}-34       & 0.0056 &  0.9386 &  0.9261 &  0.8570 \\
        \acs{poop}-\acs{resnet}-18       & 0.0075 &  0.9014 &  0.8847 &  0.7521 \\
        \hline
    \end{tabular}
    \label{tab:Results:Models:Accuracy}
\end{table}

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{images/40_results/scatter_predictions_targets.pdf}
    \caption{The predictions plotted compared to targets with the ideal drawn as a line (using \acs{poop}-\acs{resnet}-34).}
    \label{fig:Results:ScatterPredictedTarget}
\end{figure}
\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{images/40_results/histogram_predictions_targets.pdf}
    \caption{A histogram showing the distribution of predicted focus compared to annotated focus (using \acs{poop}-\acs{resnet}-34).}
    \label{fig:Results:HistogramPredictedTarget}
\end{figure}


\section{Comparison to Traditional Focus Methods}
\label{sec:Results:TraditionalFocusMethods}


\begin{table}
    \centering
    \caption{Comparing \acs{poop} to other methods in terms of accuracy of finding the best in-focus image ($\pm 1$) from a focus stack.}
    \begin{tabular}{|l|rrrrr|}
        \hline
        \multicolumn{1}{|c}{} & \multicolumn{5}{|c|}{accuracy} \\
        method            & all & trichuris & ascaris & schistosoma & hookworm \\
        \hline
        \acs{mdct}      & 0.4032 & 0.3125 & 0.6000 & 0.3125 & 0.4000 \\
        \acs{vol4}      & 0.4355 & 0.5000 & 0.6000 & 0.5000 & 0.1333 \\
        \acs{laplacian} & 0.5968 & 0.5000 & 0.7333 & 0.6250 & 0.5333 \\
        \hline
        \acs{poop}-\acs{fc} & 0.1935 & 0.2500 & 0.2000 & 0.1250 & 0.2000 \\
        \acs{poop}-\acs{cnn}            & 0.7419 & 0.6875 & 0.5333 & 0.8750 & 0.8667 \\
        \acs{poop}-\acs{resnet}-101      & 0.8226 & 0.6875 & 0.8000 & 0.8750 & 0.9333 \\
        \acs{poop}-\acs{resnet}-34       & 0.9032 & 0.9375 & 0.8667 & 0.9375 & 0.8667 \\
        \acs{poop}-\acs{resnet}-18       & 0.8226 & 0.6875 & 0.7333 & 0.8750 & 1.0000 \\ 
        \hline
    \end{tabular}
    \label{tab:Results:Comparison:RelatedWorks:Accuracy}
\end{table}

\begin{table}
    \centering
    \caption{Comparing \acs{poop} to other methods in terms of \ac{mae} of image indexes compared to the best in-focus image from a focus stack.}
    \begin{tabular}{|l|rrrrr|}
        \hline
        \multicolumn{1}{|c}{} & \multicolumn{5}{|c|}{\ac{mae}$^*$} \\
        method & all & trichuris & ascaris & schistosoma & hookworm \\
        \hline
        \acs{mdct}      & 2.3065 & 2.1250 & 1.9333 & 2.6250 & 2.5333 \\
        \acs{vol4}      & 2.2258 & 1.8750 & 1.8000 & 2.1250 & 3.1333 \\
        \acs{laplacian} & 1.5968 & 1.8125 & 1.3333 & 1.5625 & 1.6667 \\
        \hline
        \acs{poop}-\acs{fc}  & 3.2742 & 3.3125 & 3.4667 & 3.0000 & 3.3333 \\
        \acs{poop}-\acs{cnn}            & 1.0645 & 1.3750 & 1.4000 & 0.7500 & 0.7333 \\
        \acs{poop}-\acs{resnet}-101      & 0.9194 & 1.0625 & 1.0667 & 0.9375 & 0.6000 \\
        \acs{poop}-\acs{resnet}-34       & 0.6452 & 0.6250 & 0.8000 & 0.5625 & 0.6000 \\
        \acs{poop}-\acs{resnet}-18       & 0.9516 & 1.3125 & 0.8667 & 1.0625 & 0.5333 \\
        \hline
    \end{tabular}
    \label{tab:Results:Comparison:RelatedWorks:IndexMAE}
\end{table}

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{images/40_results/index_diff_to_gt_violin.pdf}
    \caption{Comparing \acs{poop} to other methods in terms of \ac{mae}$^*$ of image indexes compared to the best in-focus image from a focus stack. The same data is represented in \autoref{tab:Results:Comparison:RelatedWorks:IndexMAE}.}
    \label{fig:Results:Comparison:RelatedWorks:IndexMAE}
\end{figure}


\section{Heatmap and Stitched Image Generation}
\label{sec:Results:HeatStiched}


\begin{figure}
    \centering
    \begin{subfigure}[b]{\textwidth}
        \centering
        \caption{stack index: 4}
        \includegraphics[width=\textwidth]{images/40_results/focus_stack_4.jpg}
        \label{fig:Results:Stack:SideBySide:Index0}
    \end{subfigure}
    \begin{subfigure}[b]{\textwidth}
        \centering
        \caption{stack index: 5}
        \includegraphics[width=\textwidth]{images/40_results/focus_stack_5.jpg}
        \label{fig:Results:Stack:SideBySide:Index1}
    \end{subfigure}
    \begin{subfigure}[b]{\textwidth}
        \centering
        \caption{stack index: 6}
        \includegraphics[width=\textwidth]{images/40_results/focus_stack_6.jpg}
        \label{fig:Results:Stack:SideBySide:Index2}
    \end{subfigure}
    \begin{subfigure}[b]{\textwidth}
        \centering
        \caption{stitched image}
        \includegraphics[width=\textwidth]{images/40_results/focus_stack_stiched.png}
        \label{fig:Results:Stack:SideBySide:Stiched}
    \end{subfigure}
    \caption{Comparison of images from the focus stack to a generated combined image based on the focus prediction of the model (\acs{poop}-\acs{resnet}-34).}
    \label{fig:Results:Stack:SideBySide}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{images/40_results/focus_stack_contour_plot.pdf}
    \caption{Contour plot showing which image of the focus stack is most in focus according to the model (\acs{poop}-\acs{resnet}-34).}
    \label{fig:Results:Stack:ContourPlot}
\end{figure}

\begin{figure}
    \centering
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/40_results/heatmap_legend.pdf}
    \end{subfigure}
    \begin{subfigure}[b]{0.5\textwidth}
        \centering
        \caption{stack index 3}
        \includegraphics[width=\textwidth]{images/40_results/heatmap_layer_3.pdf}
        \label{fig:Results:Stack:HeatMap:Stack3}
    \end{subfigure}%
    \begin{subfigure}[b]{0.5\textwidth}
        \centering
        \caption{stack index 4}
        \includegraphics[width=\textwidth]{images/40_results/heatmap_layer_4.pdf}
        \label{fig:Results:Stack:HeatMap:Stack4}
    \end{subfigure}
    \par
    \begin{subfigure}[b]{0.5\textwidth}
        \centering
        \caption{stack index 5}
        \includegraphics[width=\textwidth]{images/40_results/heatmap_layer_5.pdf}
        \label{fig:Results:Stack:HeatMap:Stack5}
    \end{subfigure}%
    \begin{subfigure}[b]{0.5\textwidth}
        \centering
        \caption{stitched image}
        \includegraphics[width=\textwidth]{images/40_results/heatmap_stiched.pdf}
        \label{fig:Results:Stack:HeatMap:Stiched}
    \end{subfigure}
    \caption{Figure comparing the heatmap of images of a focus stack to a generated image based on the focus prediction model (\acs{poop}-\acs{resnet}-34).}
    \label{fig:Results:Stack:HeatMap}
\end{figure}

\section{Speed and Memory Consumption}
\label{sec:Results:Computation}

This section is detailing the hardware needed to run each model. Traditional methods need the least amount of memory and overall are the fastest. \Acl{nn} models, need the most additional memory and the memory and computation time increases with model size. 


\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{images/40_results/speed.pdf}
    \caption{The mean speed of processing a patch by model on the \ac{cpu} and \ac{gpu}.}
    \label{fig:Results:Computation:Speed}
\end{figure}

\begin{table}[ht]
    \centering
    \caption{Comparison of model speed for processing a single patch in milliseconds on the \ac{cpu} and \ac{gpu}.}
    \label{tab:Results:Computation:Speed}
    \begin{tabular}{|l|rr|rr|rr|}
        \hline
        \multicolumn{1}{|c|}{} & \multicolumn{2}{c|}{median} & \multicolumn{2}{c|}{mean} & \multicolumn{2}{c|}{std} \\
        name & \acs{gpu} & \acs{cpu} & \acs{gpu} & \acs{cpu} & \acs{gpu} & \acs{cpu} \\
        \hline
        \acs{mdct}      & 0.1716 &  0.3964 & 0.1798 &  0.4091 & 0.0201 & 0.0646 \\
        \acs{vol4}      & 0.1085 &  0.1786 & 0.1117 &  0.1779 & 0.0117 & 0.0099 \\
        \acs{laplacian} & 0.1905 &  0.4272 & 0.1923 &  0.4359 & 0.0090 & 0.0286 \\
        \hline
        \acs{poop}-\acs{fc}  & 0.3083 &  1.6677 & 0.3114 &  1.6812 & 0.0214 & 0.0608 \\
        \acs{poop}-\acs{cnn}            & 0.2637 &  1.4606 & 0.2653 &  1.4868 & 0.0202 & 0.1040 \\
        \acs{poop}-\acs{resnet}-101      & 8.9836 & 75.5439 & 8.8624 & 77.0634 & 0.4757 & 9.4337 \\
        \acs{poop}-\acs{resnet}-34       & 3.0887 & 34.0188 & 3.1879 & 33.6104 & 0.2880 & 5.4447 \\
        \acs{poop}-\acs{resnet}-18       & 1.7257 & 19.9149 & 1.7847 & 19.2682 & 0.2294 & 2.9377 \\
        \hline
    \end{tabular}
\end{table}

\todo[inline]{
    N is number of pixels
    Space usage:
    VOL4: $O(1) =>$ Store sum 
    
    MDCT: $O(1) =>$ Store sum; For convolution store in tmp variable and do addition and later potentiation.
    
    ML: Same for mean laplacian: or convolution store in tmp variable and do addition
    
    ML: models: $O(N) => maximum(channels * input\_size^2) + model\_size $
}

\todo[inline, caption={}]{
    add table with:
    \begin{itemize}
        \item model size (measured)
        \item memory usage during prediction (theory)
        \item memory usage during prediction O(notation)
        \item Potentially (speed as O notation)
    \end{itemize}
}

\begin{table}[ht]
    \centering
    \caption{Additional memory usage by each model.}
    \label{tab:Results:Computation:Memory}
    \begin{tabular}{|l|r|}
        \hline
        name & model size (MiB) \\
        \hline
        \acs{poop}-\acs{fc}         &  33.2 \\
        \acs{poop}-\acs{cnn}        &   0.8 \\
        \acs{poop}-\acs{resnet}-101 & 162.9 \\
        \acs{poop}-\acs{resnet}-34  &  82.8 \\
        \acs{poop}-\acs{resnet}-18  &  43.4 \\
        \hline
    \end{tabular}
\end{table}



\todo[inline]{
    CPU:
    microscopes: Jetson Nano: ARM Cortex-A57 4 Core 1479 MHz (cpubenchmark: 400 (single-thread), 947 (multi))
    egghead: Ryzen 5 2600X: 2406 (single), 14050 (multicore) 
    rasberry pi 4: 569 (single), 853 (multi)

    \url{https://www.cpubenchmark.net/compare/ARM-Cortex-A57-4-Core-1479-MHz-vs-AMD-Ryzen-5-2600X-vs-ARM-Cortex-A72-4-Core-1800-MHz/3914vs3235vs4078}

    GPU:
    microscopes: Jetson Nano: 236 GFLOPS (FP32)
    egghead: RTX 2070: 7465 GFLOPS (FP32) 
    rasberry pi 4: -

    \url{https://www.techpowerup.com/gpu-specs/jetson-nano-gpu.c3643}
    \url{https://www.techpowerup.com/gpu-specs/geforce-rtx-2070.c3252}

    Add estimated performance for different hardware/model combinationshttps://www.techpowerup.com/gpu-specs/jetson-nano-gpu.c3643
}
